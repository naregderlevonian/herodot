#!/bin/sh

usage() {
    cat << EOF
Usage:  herodot gpu get mode
        herodot gpu set mode integrated|hybrid
        herodot gpu set mode toggle
EOF
    exit 1
}

NVIDIA_DAEMONS=(
    "nvidia-hibernate.service"
    "nvidia-powerd.service"
    "nvidia-resume.service"
    "nvidia-suspend.service"
)

get_mode() {
    echo $(envycontrol -q)
}

get_temperature() {
    echo "$(nvidia-smi --query-gpu=temperature.gpu --format=csv,noheader)"
}

daemons() {
    local status="$1"
    for service in "${SERVICES[@]}"; do
        sudo systemctl "$status" "$service"
    done
}

set_mode() {
    local mode="$1"
    if zenity --question \
              --icon="/usr/share/icons/empty.png" \
              --text="Are you sure you want to toggle GPU to $mode? It require reboot."; then
        [ "$mode" = "hybrid" ] && daemons "enable" || daemons "disable"
        kitty sh -c "sudo envycontrol -s "$mode" && sudo mkinitcpio -P"
        notify-send "GPU" "will switch to "$mode" after reboot"
    fi
}

toggle() {
    [ $(get_mode) = "integrated" ] && set_mode "hybrid" || set_mode "integrated"
}

case "$1" in
    "get")
        case "$2" in
            "mode")
                get_mode
                ;;
            "temperature")
                get_temperature
                ;;
            *)
                usage
                ;;
        esac
        ;;
    "set")
        case "$2" in
            "mode")
                case "$3" in
                    "integrated")
                        set_mode "integrated"                
                        ;;
                    "hybrid")
                        set_mode "hybrid"
                        ;;
                    "toggle")
                        toggle
                        ;;
                    *)
                        usage
                        ;;
                esac
            ;;
            *)
                usage
                ;;
        esac
        ;;
    *)
        usage
        ;;
esac
